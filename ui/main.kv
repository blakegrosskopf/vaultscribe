#:import get_color_from_hex kivy.utils.get_color_from_hex

# ---- Unified text field styles ----
<MDTextField>:
    color_mode: "custom"
    line_color_normal: get_color_from_hex("#FFFFFF55")   # idle border
    line_color_focus:  1, 1, 1, 1   # focused border
    text_color_normal: 1, 1, 1, 1
    text_color_focus:  1, 1, 1, 1
    hint_text_color_normal: get_color_from_hex("#FFFFFF99")
    hint_text_color_focus:  1, 1, 1, 1
    cursor_color: 1, 1, 1, 1
    icon_right_color: 1, 1, 1, 1
    hint_icon_right_color: 1, 1, 1, 1

<MDDialog>:
    md_bg_color: 0.26, 0.3, 0.59, 1
    elevation: 8
    radius: [12, 12, 12, 12]
    title_color: 1, 1, 1, 1
    text_color: 1, 1, 1, 1

# ===================================================================

# NOTE: The TOTP cards were previously inlined here and caused a full-screen overlay
# that captured touches. The modal UI is now created in Python; the Screen rules
# below are the real screens and should not contain nested Screen widgets.

<homeScreen>:
    # Home screen (login) content
    canvas.before:
        Color:
            rgba: 0.286, 0.333, 0.667, 1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:

        # ---------- HEADER (logo aligned with other screens) ----------
        Image:
            source: "../assets/logo.png"
            size_hint: None, None
            width: "400dp"
            height: "180dp"
            allow_stretch: True
            keep_ratio: True
            mipmap: True
            nocache: True
            pos_hint: {"center_x": 0.5, "top": 0.92}

        # ---------- CENTER (LOGIN CARD) ----------
        MDCard:
            size_hint: 0.92, None
            pos_hint: {"center_x": 0.5, "center_y": 0.44}  # lowered to clear the logo shadow
            height: self.minimum_height
            padding: "16dp"
            radius: [18]
            md_bg_color: 0.26, 0.3, 0.59, 1
            BoxLayout:
                orientation: "vertical"
                spacing: "12dp"
                size_hint_y: None
                height: self.minimum_height

                MDTextField:
                    id: user
                    hint_text: "Email"
                    icon_right: "account"
                    multiline: False
                    size_hint_y: None
                    height: "56dp"
                    hint_text: "Email"
                    _no_floating_label: True


                MDTextField:
                    id: psswd
                    hint_text: "Password"
                    password: True
                    icon_right: "eye-off"
                    multiline: False
                    size_hint_y: None
                    height: "56dp"
                    _no_floating_label: True
                BoxLayout:
                    size_hint_y: None
                    height: "30dp"
                    spacing: "16dp"

                    BoxLayout:
                        spacing: "6dp"
                        size_hint_x: 1
                        MDCheckbox:
                            id: cb_show
                            size_hint: None, None
                            width: "22dp"
                            height: "22dp"
                            on_active:
                                psswd.password = not self.active
                                psswd.icon_right = "eye" if self.active else "eye-off"
                        MDLabel:
                            text: "Show Password"
                            font_size: "14dp"
                            size_hint_x: None
                            width: "140dp"
                            halign: "left"
                            valign: "middle"

                BoxLayout:
                    size_hint_y: None
                    height: "44dp"
                    spacing: "10dp"
                    MDFlatButton:
                        text: "Sign in"
                        font_size: "20dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.verify(user.text, psswd.text)
                    MDFlatButton:
                        text: "Create account"
                        font_size: "20dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.manager.current = 'signUp'
                        on_press: root.clear_fields()

        # ---------- TAGLINE (short, modern) ----------
        MDLabel:
            text: "Transcribed, Encrypted, and Secured."
            halign: "center"
            font_size: "15dp"
            color: 1, 1, 1, 0.9
            size_hint: 1, None
            height: "28dp"
            pos_hint: {"center_x": 0.5, "y": 0.14}

        # ---------- FOOTER ----------
        MDLabel:
            text: "[ref=Reset Password]Reset Password[/ref]"
            markup: True
            font_size: "15dp"
            halign: "center"
            color: 1, 1, 1, 1
            size_hint: 1, None
            height: "40dp"
            pos_hint: {"center_x": 0.5, "y": 0.02}
            on_ref_press: root.manager.current = 'changeScreen'
            on_ref_press: root.clear_fields()



# SignUp screen â€” the TOTP/QR is now shown via modal created in Python
<signUp>:
    canvas.before:
        Color:
            rgba: 0.286, 0.333, 0.667, 1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:

        # Header logo (same placement as Home)
        Image:
            source: "../assets/logo.png"
            size_hint: None, None
            width: "400dp"
            height: "180dp"
            allow_stretch: True
            keep_ratio: True
            pos_hint: {"center_x": 0.5, "top": 0.92}

        # Sign-up card
        MDCard:
            size_hint: 0.92, None
            pos_hint: {"center_x": 0.5, "center_y": 0.44}
            height: self.minimum_height
            padding: "16dp"
            radius: [18]
            md_bg_color: 0.26, 0.3, 0.59, 1
            BoxLayout:
                orientation: "vertical"
                spacing: "12dp"
                size_hint_y: None
                height: self.minimum_height

                MDTextField:
                    id: username_input
                    hint_text: "Email"
                    icon_right: "account"
                    multiline: False
                    size_hint_y: None
                    height: "56dp"

                MDTextField:
                    id: password_input
                    hint_text: "Password"
                    password: True
                    icon_right: "eye-off"
                    multiline: False
                    size_hint_y: None
                    height: "56dp"

                BoxLayout:
                    id: cBox
                    size_hint_y: None
                    height: "30dp"
                    spacing: "8dp"
                    MDCheckbox:
                        id: cb
                        size_hint: None, None
                        width: "28dp"
                        height: "28dp"
                        on_press:
                            password_input.password = not password_input.password
                            password_input.icon_right = "eye" if password_input.icon_right == "eye-off" else "eye-off"
                    MDLabel:
                        text: "Show Password"
                        font_size: "14dp"
                        size_hint_x: None
                        width: "140dp"

                BoxLayout:
                    id: sBox
                    size_hint_y: None
                    height: "40dp"
                    spacing: "10dp"
                    MDFlatButton:
                        text: "Create account"
                        font_size: "18dp"
                        md_bg_color: "#1E88E5"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.create_user(username_input.text, password_input.text)
                    MDFlatButton:
                        text: "Back"
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.manager.current = 'home'
                        on_press: root.clear_fields()

        # ---------- SIGN UP TAGLINE ----------
        MDLabel:
            text: "Create your secure, local-first account."
            halign: "center"
            font_size: "15dp"
            color: 1, 1, 1, 0.9
            size_hint: 1, None
            height: "28dp"
            pos_hint: {"center_x": 0.5, "y": 0.14}



# Change screen
<changeScreen>:
    canvas.before:
        Color:
            rgba: 0.286, 0.333, 0.667, 1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:

        Image:
            source: "../assets/logo.png"
            size_hint: None, None
            width: "400dp"
            height: "180dp"
            allow_stretch: True
            keep_ratio: True
            pos_hint: {"center_x": 0.5, "top": 0.92}

        MDCard:
            size_hint: 0.92, None
            pos_hint: {"center_x": 0.5, "center_y": 0.44}   # kept low so it clears the logo
            height: self.minimum_height
            padding: "16dp"
            radius: [18]
            md_bg_color: 0.26, 0.3, 0.59, 1
            BoxLayout:
                orientation: "vertical"
                spacing: "12dp"
                size_hint_y: None
                height: self.minimum_height

                MDTextField:
                    id: email
                    hint_text: "Email"
                    icon_right: "account"
                    multiline: False
                    size_hint_y: None
                    height: "56dp"

                BoxLayout:
                    size_hint_y: None
                    height: "40dp"
                    spacing: "10dp"
                    MDFlatButton:
                        text: "Submit"
                        font_size: "18dp"
                        md_bg_color: "#1E88E5"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.start_password_reset(email.text)
                    MDFlatButton:
                        text: "Back"
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.manager.current = 'home'

        # Friendly tagline (same placement as Home)
        MDLabel:
            text: "Lost your key? Reset it securely."
            halign: "center"
            font_size: "15dp"
            color: 1, 1, 1, 0.9
            size_hint: 1, None
            height: "28dp"
            pos_hint: {"center_x": 0.5, "y": 0.14}



# Signed-in screen
<sScreen>:
    canvas.before:
        Color:
            rgba: 0.286, 0.333, 0.667, 1
        Rectangle:
            pos: self.pos
            size: self.size

    FloatLayout:

        Image:
            source: "../assets/logo.png"
            size_hint: None, None
            width: "400dp"
            height: "180dp"
            allow_stretch: True
            keep_ratio: True
            pos_hint: {"center_x": 0.5, "top": 0.92}

        MDCard:
            size_hint: 0.92, None
            pos_hint: {"center_x": 0.5, "center_y": 0.18}
            height: "100dp"
            padding: "12dp"
            radius: [18]
            md_bg_color: 0.26, 0.3, 0.59, 1
            BoxLayout:
                orientation: "vertical"
                spacing: "10dp"
                MDLabel:
                    text: "[b]Securely Signed-In[/b]"
                    markup: True
                    halign: "center"
                    font_size: "30dp"
                    text_style: "H2"
                    color: "#FFFFFF"
                BoxLayout:
                    spacing: "6dp"
                    orientation: "horizontal"
                    MDFlatButton:
                        id: lBox
                        text: "[b]Log out[/b]"
                        markup: True
                        font_size: "14dp"
                        md_bg_color: "#1E88E5"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        halign: "center"
                        size_hint_x: 0.5
                        on_press: root.logout()
                    MDFlatButton:
                        text: "[b]Exit Application[/b]"
                        markup: True
                        font_size: "14dp"
                        md_bg_color: "#D32F2F"
                        theme_text_color: "Custom"
                        size_hint_x: 0.5
                        halign: "center"
                        text_color: 1,1,1,1
                        on_press: app.stop()

        MDCard:
            size_hint: 0.92, None
            pos_hint: {"center_x": 0.5, "y": 0.32}
            height: "210dp"
            padding: "20dp"
            radius: [18]
            md_bg_color: 0.26, 0.3, 0.59, 1
            BoxLayout:
                orientation: "vertical"
                spacing: "10dp"
                MDLabel:
                    text: "[b]Home[/b]"
                    markup: True
                    halign: "center"
                    valign: "top"
                    font_size: "34dp"
                    text_style: "H2"
                    color: 1, 1, 1, 0.9
                BoxLayout:
                    orientation: "horizontal"
                    spacing: "6dp"
                    MDFlatButton:
                        text: "[b]Transcribe[/b]"
                        markup: True
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        size_hint_x: 0.5
                        size_hint_y: 1
                        on_press: root.manager.current = 'transcribeScreen'
                    MDFlatButton:
                        text: "[b]Storage[/b]"
                        markup: True
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        size_hint_x: 0.5
                        size_hint_y: 1
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.manager.current = 'storageScreen'
                BoxLayout:
                    orientation: "horizontal"
                    spacing: "6dp"
                    MDFlatButton:
                        text: "[b]Settings[/b]"
                        markup: True
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        size_hint_x: 0.5
                        size_hint_y: 1
                        on_press: root.manager.current = 'settingsScreen'
                    MDFlatButton:
                        text: "[b]Help[/b]"
                        markup: True
                        font_size: "18dp"
                        md_bg_color: "#303F9F"
                        size_hint_x: 0.5
                        size_hint_y: 1
                        theme_text_color: "Custom"
                        text_color: 1,1,1,1
                        on_press: root.manager.current = 'helpScreen'


